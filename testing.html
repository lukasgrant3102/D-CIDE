<!doctype html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
        <link rel="stylesheet" href="./styles/styles.css">
        <meta http-equiv="Cache-control" content="no-cache">
    </head>

    <body>
        
        <div id="main">
            <textarea id="textArea">This is my text area</textarea>
        </div>

    </body>

    <script>

        const site_link = window.location.href;

        const regex = /\/\/([^:/]+):(\d+)/;
        const match = site_link.match(regex);
        let site_ip = "unknown";
        let port = 8080;

        if (match) {
            site_ip = match[1];
            port = match[2];
            
            console.log("IP Address:", site_ip);
            console.log("Port:", port);
        }
        else {
            console.log("Could not extract the site ip.");
        }

        document.addEventListener("DOMContentLoaded", function () {

            let isHost = false;
            let main = document.getElementById("main");
            main.innerHTML="<button onclick='toggleSharing()'>Toggle sharing</button> <button onclick='setHost()'>Become host</button>" + main.innerHTML;

            fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(data => {

                    //Start main app here.
                    let user_ip = data.ip;
                    console.log(user_ip);

                    const textUpdateInterval = setInterval(() => {
                        fetch('http://' + site_ip + ':' + port + '/getShareValue').then(response => response.json()).then(data => {
                            isSharing = data;
                            console.log("isSharing: " + isSharing);
                        });

                        let textArea = document.getElementById("textArea");
                        let userText = textArea.value;

                        if(isHost) {
                            fetch('http://' + site_ip + ':' + port + '/updateCurrentText', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(userText),
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log('Updated user_texts with:', data);
                            })
                            .catch(error => {
                                console.log('Error updating user_texts:', error);
                            });
                        }


                    }, 2000);

                });

        });

        function setHost() {
            console.log("you are now host");
            isHost = true;
        }

        function toggleSharing() {
            fetch('http://' + site_ip + ':' + port + '/setShareValue', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({value: false}),
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Updated user:', data);
                    })
                    .catch(error => {
                        console.error('Error updating currentText:', error);
                    });
        }


    </script>
</html>
